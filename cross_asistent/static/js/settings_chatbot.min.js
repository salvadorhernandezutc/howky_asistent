var alfabetico="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz12345678901234567890",texto3=/[a-zA-Z0-9]{3}/;const isMobile=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);$(document).ready(function(){try{const n=$("#asistent_model");let i=!1;function e(){i=!i,i?n[0].pause():n[0].play()}$("#openChat").on("click",function(){$("#model").toggleClass("open"),e()});const r=n.attr("data-camera-orbit");function t(){const t=r.split(" "),o=`${-1*t[0].replace("deg","")}deg ${t[1]} ${t[2]}`,a=localStorage.getItem("model_hdr");$("body").hasClass("open_map")||(n.attr("environment-image",""),n.attr("skybox-image","")),setTimeout(()=>{$("body").hasClass("open_map")?($("#chatOpenMap i.fa-solid").addClass("fa-comment-dots").removeClass("fa-map-location-dot"),n.attr("camera-orbit",o)):($("#chatOpenMap i.fa-solid").addClass("fa-map-location-dot").removeClass("fa-comment-dots"),n.attr("camera-orbit",r),null!==a&&""!==a&&(n.attr("environment-image",`/media/hdri/${a}.hdr`),n.attr("skybox-image",`/media/hdri/${a}.hdr`))),$("#model").hasClass("open")&&e()},500)}$("#chatOpenMap").on("click",t),$(document).on("click","[data-route]",function(){!0===$("body").hasClass("open_map")||(t(),$("body").addClass("open_map"));const e=$(this).attr("data-route").split("~"),o=new URLSearchParams(window.location.search);o.set("origin",e[0]),o.set("destiny",e[1]),history.replaceState({},"",`${location.pathname}?${o}`)}),$("#txtQuestion").keydown(e=>{13!==e.keyCode||e.shiftKey||(e.preventDefault(),$("#chatForm_submit").click())}),$("#chatForm").submit(chatSubmit);const c=window.SpeechRecognition||window.webkitSpeechRecognition;if(!c)return $("#chatMicrophone").remove(),$("#chatListeningGroup").remove(),$("#keywordChatGroup").remove(),void $("#chatListeningAll").prop("checked",!1);const l=new c;l.lang="es-ES",l.continuous=!0,l.interimResults=!1;let d=!1;function o(){if(!d){l.start(),d=!0,$("#chatMicrophone").html('<i class="ic-solar litening_bars"></i>'),console.log("🎤 Iniciando reconocimiento de voz.---------------------");var e=$("#recordingStartSound")[0];e.currentTime=0,e.play()}}function a(){if(d){l.stop(),d=!1,$("#chatMicrophone").html('<i class="fa-solid fa-microphone"></i>'),console.log("🛑 Detenido reconocimiento de voz.---------------------");var e=$("#recordingEndSound")[0];e.currentTime=0,e.play()}}"true"===localStorage.getItem("chatListening")&&o(),$("#chatMicrophone").on("click",()=>d?a():o()),$("#chatListeningAll").on("change",function(){$(this).is(":checked")?o():a()});const m=[{nombre:"abrirMapa",expresiones:[/\b(abrir|abre|muestra|mostrar)(\s+el)?\s+mapa\b/i],accion:()=>{$("body").hasClass("open_map")||$("#chatOpenMap").click()}},{nombre:"cerrarMapa",expresiones:[/\b(cerrar|cierra|oculta(r)?)(\s+el)?\s+mapa\b/i],accion:()=>{$("body").hasClass("open_map")&&$("#chatOpenMap").click()}},{nombre:"abrirChat",expresiones:[/\b(abrir|abre|mostrar|muestra)(\s+el)?\s+chat\b/i],accion:()=>{$("body").hasClass("open_chat")||$("#chatOpen").click()}},{nombre:"cerrarChat",expresiones:[/\b(cerrar|cierra|oculta(r)?)(\s+el)?\s+chat\b/i],accion:()=>{$("body").hasClass("open_chat")&&$("#chatOpen").click()}},{nombre:"iniciarRuta",expresiones:[/\b(cómo\s+ir|como\s+ir|como\s+llegar|cómo\s+llegar|ruta\s+a|indicaciones?)\b/i],accion:()=>{setTimeout(()=>{$("[data-route]").last().click()},2e3)}},{nombre:"borrarRuta",expresiones:[/\b(borra(r)?|elimina(r)?)(\s+la|\s+una|\s+las|\s+los)?\s+ruta\b|\b(borra(r)?|elimina(r)?)(\s+el|\s+las|\s+los)?\s+camino(s)?\b/i],accion:()=>{$('[data-reset_form="form_route"]').click()}},{nombre:"TemaClaro",expresiones:[/\btema (claro|diurno)\b/i],accion:()=>{const e=$("html").attr("data-mdb-theme");console.log("tema actual:",e),"dark"==e&&$("#switchTheme").click()}},{nombre:"TemaOscuro",expresiones:[/\btema (oscuro|nocturno)\b/i],accion:()=>{const e=$("html").attr("data-mdb-theme");console.log("tema actual:",e),"light"==e&&$("#switchTheme").click()}},{nombre:"CambiarTema",expresiones:[/\bcambia(r)?(\s+el)? tema\b/i],accion:()=>$("#switchTheme").click()}];function s(e){console.log("💬 Enviando al chat:",e),$("#txtQuestion").text(e),setTimeout(()=>{$("#chatForm").submit(),setTimeout(()=>$("#txtQuestion").text(""),500)},1e3)}l.onresult=function(e){const t=e.results[e.results.length-1][0].transcript.trim().toLowerCase();console.log("🗣️ Detectado:",t);const o=["howky","hockey","hawkie","hawking","hauki","houki","asistente","okay","ok"],a=$("#keywordChatAll").is(":checked");let n=t.split(/\s+/);const i=n.some(e=>o.includes(e));if(!a&&!i)return void console.log("❌ Palabra clave no detectada.");const r=n.filter(e=>!o.includes(e)).join(" ").trim();console.log("🎯 Comando filtrado:",r);let c=!1;for(let e of m)if(e.expresiones.some(e=>e.test(r))){console.log("✅ Ejecutando:",e.nombre),e.accion(),"iniciarRuta"===e.nombre&&s(r),c=!0;break}!c&&r&&s(r)},l.onend=function(){console.log("🔁 Reconocimiento finalizado automáticamente.--------");"true"===localStorage.getItem("chatListening")?(d=!1,o()):(d=!0,a())},l.onerror=function(e){const t="true"===localStorage.getItem("chatListening");t&&"no-speech"===e.error?a():t&&"not-allowed"===e.error&&(localStorage.setItem("chatListening",!1),$("#chatListeningAll").prop("checked",!1),alertSToast("center",8e3,"error","Habilita los permisos de micrófono para usar el reconocimiento de voz."))},$("#chatCtrlsAll").on("change",function(){$(this).is(":checked")?$("#chatForm").addClass("hidden_chat"):$("#chatForm").removeClass("hidden_chat")});"true"===localStorage.getItem("chatCtrls")?$("#chatForm").addClass("hidden_chat"):$("#chatForm").removeClass("hidden_chat")}catch(u){console.error("Error Inesperado: ",u),alertSToast("center",8e3,"error","😥 Ha ocurrido un error inesperado. código: #304")}});const contOutput=document.querySelector("#output");let audioEnabled=!0,saludoMostrado=!0;function chatSubmit(e){e.preventDefault();const t=cadenaRandom(5,alfabetico),o=txtQuestion.value,a=e.target;a.reset();const s=`<div class="chat_msg d-flex justify-content-end user_submit" data-tokeid="uuid${t}"><div class="msg_user p-2 bg_detail">${o}</div></div>`;contOutput.insertAdjacentHTML("beforeend",s);const n=$(`.user_submit[data-tokeid="uuid${t}"]`);setTimeout(()=>{n.removeClass("active").addClass("show"),setTimeout(scrollToBottom,500),setTimeout(()=>{n.addClass("active")},5e3)},20);if(contOutput.insertAdjacentHTML("beforeend",'<div class="chat_msg chat_open my-4" data-tokeid="loadInfoDelete"><div class="msg_response"><div class="mx-auto pulse-container"><div class="pulse-bubble bg_detail"></div><div class="pulse-bubble bg_detail"></div><div class="pulse-bubble bg_detail"></div></div></div></div>'),setTimeout(function(){$('.chat_msg[data-tokeid="loadInfoDelete"]').addClass("show"),setTimeout(scrollToBottom,500)},200),!texto3.test(o)){return void displayText("No comprendo a lo que te refieres, por dame mas detalles de lo que deseas saber <br> Mientras mas detalles mejor 😊😉.")}fetch(a.action,{method:"POST",body:JSON.stringify({question:o}),headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest","X-CSRFToken":a.querySelector("[name=csrfmiddlewaretoken]").value}}).then(e=>e.ok?e.json():e.json().then(e=>{throw new Error(e.message||"Error desconocido")})).then(e=>{if(e.success)displayResponse(e.answer);else{console.error("😥 Error: ------------------------------"),console.error(e.message),console.error("😥 Error: ------------------------------");displayText("Lo siento pero no puedo responder en este momento. <br> La verdad es que hoy me sature de tantas solicitudes y no puedo procesar más. 😥🤒 <br> Estare de nuevo en funcionamineto muy pronto. 😊😉😌")}}).catch(e=>{console.error("😥 Error:",e),alertSToast("top",8e3,"warning","Ocurrió un error. Intente nuevamente. 😥")})}function displayResponse(e){const t=cadenaRandom(5,alfabetico),o=e.imagenes,a=e.redirigir;let s="",n="";if(null!=o&&(s=`<div class="chat_msg show"><img src="${o}" alt="${e.titulo}" class="chat_img" /></div>`),a&&""!==a.trim()){const e=a.includes("~");n=`\n            <div class="chat_msg show msg_link">\n                <${e?'button type="button" data-route':"a href"}="${a}" class="btn btn_detail_inset">\n                    ${e?"Abrir ruta en el Mapa":"Ver más"} <i class="fas fa-up-right-from-square ms-1"></i>\n                </${e?"button":"a"}>\n            </div>\n        `}const i=`<div class="chat_msg chat_open" data-tokeid="uuid${t}"><div class="msg_response">${e.informacion.replace(/\n/g,"<br>").replace(/\*\*(.*?)\*\*/g,"$1").replace(/\*(.*?)\*/g,"$1").replace(/^\s*[\-\*]\s+/gm,"").replace(/`([^`]*)`/g,"$1")}</div></div>${s} ${n}`;contOutput.insertAdjacentHTML("beforeend",i);const r=document.querySelector(`.chat_msg[data-tokeid="uuid${t}"]`);$('.chat_msg[data-tokeid="loadInfoDelete"]').remove(),setTimeout(function(){r.classList.add("show"),setTimeout(scrollToBottom,350)},20)}function displayText(e){$('.chat_msg[data-tokeid="loadInfoDelete"]').remove();const t=cadenaRandom(5,alfabetico),o=`<div class="chat_msg chat_open" data-tokeid="uuid${t}"><div class="msg_response">${e.replace(/\n/g,"<br>")}</div></div>`;contOutput.insertAdjacentHTML("beforeend",o);const a=document.querySelector(`.chat_msg[data-tokeid="uuid${t}"]`);setTimeout(function(){a.classList.add("show"),setTimeout(scrollToBottom,350)},20)}if(contOutput&&saludoMostrado){const e='<div class="chat_msg chat_open" data-tokeid="initialMessage"><div class="msg_response">Soy Hawky 👋😁, tu asistente virtual de la Universidad Tecnológica de Coahuila. Puedes preguntarme sobre trámites, carreras, costos u otros temas de la universidad. ¿En qué puedo ayudarte?😉😊😁</div></div>';contOutput.insertAdjacentHTML("beforeend",e);const t=document.querySelector('.chat_msg[data-tokeid="initialMessage"]');setTimeout(function(){t.classList.add("show")},500)}function scrollToBottom(){contOutput.scrollTop=contOutput.scrollHeight}if(contOutput){const e=new MutationObserver(()=>{scrollToBottom()});scrollToBottom(),e.observe(contOutput,{childList:!0,subtree:!0})}