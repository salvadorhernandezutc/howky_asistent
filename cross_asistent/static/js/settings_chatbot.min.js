function chatSubmit(e){newMessageChat=!0,e.preventDefault();const o=txtQuestion.value,t=e.target;if(t.reset(),!texto3.test(o))return alertSToast("center",6e3,"warning","Por favor, envía una pregunta más descriptiva 🧐😯😬");const s=cadenaRandom(5,alfabetico),n=`uuid${s}`,a=`<div class="chat_msg d-flex justify-content-end user_submit" data-tokeid="${n}"><div class="msg_user p-2 bg_detail">${o}</div></div>`;contOutput.insertAdjacentHTML("beforeend",a);const r=$(`.user_submit[data-tokeid="${n}"]`);setTimeout(()=>{r.removeClass("active").addClass("active"),setTimeout(scrollToBottom,500),setTimeout(()=>{r.addClass("active")},5e3)},20);const i='<div class="chat_msg chat_open" data-tokeid="loadInfoDelete"><div class="msg_response"><div class="mx-auto pulse-container"><div class="pulse-bubble bg_detail"></div><div class="pulse-bubble bg_detail"></div><div class="pulse-bubble bg_detail"></div></div></div></div>';contOutput.insertAdjacentHTML("beforeend",i),setTimeout(function(){document.querySelector('.chat_msg[data-tokeid="loadInfoDelete"]').classList.add("show"),setTimeout(scrollToBottom,500)},200),microphonerecord&&$(".speak_btn i").removeClass("fa-volume-high").addClass("fa-spinner fa-spin-pulse"),fetch(t.action,{method:"POST",body:JSON.stringify({question:o}),headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest","X-CSRFToken":t.querySelector("[name=csrfmiddlewaretoken]").value}}).then(e=>e.ok?e.json():e.json().then(e=>{throw new Error(e.message||"Error desconocido")})).then(e=>{e.success?(microphonerecord&&$(".speak_btn i").removeClass("fa-volume-high fa-spinner fa-spin-pulse").addClass("fa-volume-xmark"),displayChatbotResponse(e.answer)):(console.error("😥 Error:",e.message),alertSToast("top",8e3,"error",`Error: ${e.message}`))}).catch(e=>{console.error("😥 Error:",e),alertSToast("top",8e3,"warning","Ocurrió un error. Intente nuevamente. 😥")})}function displayChatbotResponse(e){const o=cadenaRandom(5,alfabetico),t=`uuid${o}`,s=e.imagenes,n=e.redirigir,a=e.blank;let r="",i="",c="";null!=s&&(r=`<div class="chat_msg show"><img src="${s}" alt="${e.titulo}" class="chat_img" /></div>`),a&&(i='target="_blank" rel="noopener noreferrer"'),n&&""!==n.trim()&&(c=`<div class="chat_msg show msg_link"><a href="${n}" ${i} class="btn bg_detail">Ver más <i class="fas fa-up-right-from-square ms-1"></i></a></div>`),lastText=e.informacion,chatText=e.informacion.replace(/\n/g,"<br>");const l=`<div class="chat_msg chat_open" data-tokeid="${t}"><div class="msg_response">${chatText}</div></div>${r} ${c}`;contOutput.insertAdjacentHTML("beforeend",l);const d=document.querySelector(`.chat_msg[data-tokeid="${t}"]`);document.querySelector('.chat_msg[data-tokeid="loadInfoDelete"]').remove(),setTimeout(function(){if(d.classList.add("show"),setTimeout(scrollToBottom,350),microphonerecord){let e=$(`[data-tokeid="${t}"]`).text();ttsCustom(e)}},20)}function scrollToBottom(){contOutput.scrollTop=contOutput.scrollHeight}function alertSToast(e,o,t,s,n){const a=Swal.mixin({toast:!0,position:e,showConfirmButton:!1,showCloseButton:!0,timer:o,timerProgressBar:!0,customClass:{icon:"icon_alert",title:"title_alert",timerProgressBar:"progressbar_alert",closeButton:"close_button_alert"},didOpen:e=>{e.addEventListener("mouseenter",Swal.stopTimer),e.addEventListener("mouseleave",Swal.resumeTimer)},didDestroy:n});a.fire({icon:t,title:s})}var alfabetico="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz12345678901234567890",texto3=/[a-zA-Z0-9]{3}/;const isMobile=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);let microphonerecord=!1,newMessageChat=!1,lastText="",microphoneSpeech=!0,isSpeaking=!1;const recVoice=$(".controls_btn_microphone"),textarea=document.getElementById("txtQuestion"),submitButton=document.getElementById("chatForm_submit");let recognition,finalTranscript="",recognizing=!1;const speakButton=$(".speak_btn"),voiceSelect=document.getElementById("voice_select"),rateInput=document.getElementById("rate_input");$(document).ready(function(){try{function e(){microphoneSpeech?$("#btn_controls_icon").removeClass("fa-comment").addClass("fa-microphone"):$("#btn_controls_icon").removeClass("fa-comment").addClass("fa-microphone-slash")}recVoice.click(()=>{$(".asistent_group").addClass("open open_controls"),$(".btn_controls").addClass("text-white"),e(),setTimeout(()=>{$(".btn_controls").addClass("readyRecVoice")},1100)}),$(".asistent_group").hasClass("open")&&e();let o=!1;$("#openChat").on("click",function(){$("main").toggleClass("open");const e=$("#asistent_model");o=!o,o?e[0].pause():e[0].play(),o?console.log("PAUSE: ",e[0].pause()):console.log("PLAY: ",e[0].play())}),$(".toggle_controls").click(()=>{microphonerecord=!1;const e=$(".asistent_group.open");e.toggleClass("close_controls open_keyboard open_controls"),isMobile||setTimeout(function(){$(".controls_input #txtQuestion").focus()},900);let o=$("#asistent_model");const t=localStorage.getItem("model_hdr");e.hasClass("open_keyboard")?($("#changeScene").addClass("none").css("--delay","8"),$("#floatSettings").addClass("none").css("--delay","5"),o.attr("environment-image",""),o.attr("skybox-image","")):($("#changeScene").removeClass("none").css("--delay","1"),$("#floatSettings").removeClass("none").css("--delay","1"),""!=t?(o.attr("environment-image",`/media/hdri/${t}.hdr`),o.attr("skybox-image",`/media/hdri/${t}.hdr`)):(o.attr("environment-image",""),o.attr("skybox-image","")))}),$(".controls_btn_close").click(()=>{$(".asistent_group").removeClass("open open_controls close_controls open_keyboard"),$(".btn_controls").removeClass("readyRecVoice"),$("#btn_controls_icon").addClass("fa-comment").removeClass("fa-microphone"),recognizing&&stopRecording()}),$("#txtQuestion").keydown(e=>{13!==e.keyCode||e.shiftKey||(e.preventDefault(),$("#chatForm_submit").click())});const t=$("#vesticalCtrls"),s=$("#asistentNavigation"),n=localStorage.getItem("Vertical-controls");"true"===n?(t.prop("checked","checked"),s.addClass("controls_vertical")):"false"===n&&(t.prop("checked",""),s.removeClass("controls_vertical")),t.on("click",function(){const e=t.is(":checked");s.toggleClass("controls_vertical",e),localStorage.setItem("Vertical-controls",e)}),$("#chatForm").submit(chatSubmit)}catch(e){console.error("Error Inesperado: ",e),alertSToast("center",8e3,"error","😥 Ha ocurrido un error inesperado. código: #304")}});try{if("webkitSpeechRecognition"in window){function stopRecording(){recognition.stop(),$("#btn_controls_icon").addClass("fa-microphone").removeClass("fa-stop")}recognition=new webkitSpeechRecognition,recognition.lang="es-MX",recognition.continuous=!0,recognition.interimResults=!0,recognition.onstart=function(){recognizing=!0,microphonerecord=!0,finalTranscript=""},recognition.onresult=function(e){let o="";for(let t=e.resultIndex;t<e.results.length;t++){let s=e.results[t][0].transcript;e.results[t].isFinal?finalTranscript+=s:o+=s}textarea.value=finalTranscript+o},recognition.onerror=function(e){console.error("Error de reconocimiento:",e.error),"not-allowed"===e.error?alertSToast("top",8e3,"error","Permiso de micrófono denegado. Por favor, permite el acceso al micrófono."):"no-speech"===e.error?alertSToast("top",8e3,"error","No se detectó ninguna voz. Por favor, intenta de nuevo."):"network"===e.error&&alertSToast("top",8e3,"error","Error de red. Por favor, verifica tu conexión."),console.error("Error de reconocimiento: ",e.error),recognizing=!1,microphonerecord=!1,$("#btn_controls_icon").removeClass("fa-stop").addClass("fa-microphone"),$(".btn_controls").removeClass("readyRecVoice")},recognition.onend=function(){recognizing=!1,$("#btn_controls_icon").removeClass("fa-stop").addClass("fa-microphone")},recVoice.on("click",function(){if(recVoice.hasClass("readyRecVoice"))if(recognizing)stopRecording(),setTimeout(()=>{submitButton.click()},500);else try{isSpeaking=!0,speakButton.click(),$("#btn_controls_icon").addClass("fa-stop").removeClass("fa-microphone"),recognition.start()}catch(e){console.error("Error al iniciar el reconocimiento: ",e),alertSToast("top",8e3,"error","No se pudo iniciar el reconocimiento de voz.")}})}else microphoneSpeech=!1,console.warn("Este navegador no soporta la Web Speech API"),$("#btn_controls_icon").addClass("fa-microphone-slash"),recVoice.on("click",function(){alertSToast("center",9e3,"warning","Al parecer tu navegador no permite activar el micrófono. 🤔😯😥")})}catch(e){alertSToast("top",1e4,"warning",e)}if("speechSynthesis"in window){const e=window.speechSynthesis;let o,t=[];function loadVoices(){t=e.getVoices(),voiceSelect.innerHTML="";let o=!1;t.forEach((e,t)=>{if(e.lang.startsWith("es")){const s=document.createElement("option");s.textContent=`${e.name} (${e.lang})`,s.value=t,voiceSelect.appendChild(s),e.name.includes("Microsoft Sebastian")&&"es-VE"===e.lang?(voiceSelect.value=t,o=!0):e.name.includes("Microsoft Raul")&&"es-Mx"===e.lang&&(voiceSelect.value=t,o=!0)}}),!o&&voiceSelect.options.length>0&&(voiceSelect.value=0)}function removeEmojis(e){return e.replace("*","").replace("#","").replace("(","").replace(")","").replace(">","").replace("<","").replace("br","").replace("<br>","").replace(/[\u{1F600}-\u{1F64F}]/gu,"").replace(/[\u{1F300}-\u{1F5FF}]/gu,"").replace(/[\u{1F680}-\u{1F6FF}]/gu,"").replace(/[\u{2600}-\u{26FF}]/gu,"").replace(/[\u{2700}-\u{27BF}]/gu,"").replace(/[\u{1F900}-\u{1F9FF}]/gu,"").replace(/[\u{1FA70}-\u{1FAFF}]/gu,"")}function ttsCustom(s){if(isSpeaking)$(".speak_btn i").addClass("fa-volume-high").removeClass("fa-volume-xmark"),e.cancel(),isSpeaking=!1;else{$(".speak_btn i").removeClass("fa-volume-high").addClass("fa-volume-xmark"),s=removeEmojis(s),o=new SpeechSynthesisUtterance(s);const n=t[voiceSelect.value];o.voice=n,o.rate=parseFloat(rateInput.value)||1,e.speak(o),isSpeaking=!0,o.onend=(()=>{isSpeaking=!1,$(".speak_btn i").addClass("fa-volume-high").removeClass("fa-volume-xmark")})}}void 0!==e.onvoiceschanged&&(e.onvoiceschanged=loadVoices),loadVoices()}else console.warn("Este navegador no soporta API de síntesis de voz"),alertSToast("center",7e3,"warning","Al parecer tu navegador no permite la API de síntesis de voz. 😯😥🥲");document.addEventListener("DOMContentLoaded",()=>{let e=$('[data-tokeid="initialMessage"]').text();speakButton.on("click",()=>{newMessageChat||ttsCustom(e)})});const contOutput=document.querySelector("#output");let audioEnabled=!0,saludoMostrado=!0;if(speakButton.on("click",()=>{newMessageChat&&ttsCustom(lastText)}),contOutput&&saludoMostrado){const e='<div class="chat_msg chat_open" data-tokeid="initialMessage"><div class="msg_response">¡Hola! Soy Hawky 👋😁, tu asistente virtual de la Universidad Tecnológica de Coahuila. Puedes preguntarme sobre trámites, carreras, costos u otros temas de la universidad. ¿En qué puedo ayudarte?😉😊😁</div></div>';contOutput.insertAdjacentHTML("beforeend",e);const o=document.querySelector('.chat_msg[data-tokeid="initialMessage"]');setTimeout(function(){o.classList.add("show")},500)}if(contOutput){function scrollToBottom(){contOutput.scrollTop=contOutput.scrollHeight}var observer=new MutationObserver(()=>{scrollToBottom()});scrollToBottom(),observer.observe(contOutput,{childList:!0,subtree:!0})}