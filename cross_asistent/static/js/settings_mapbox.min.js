window.addEventListener("load",()=>{function e(e){if(e){l.forEach(e=>e.classList.remove("btn_detail","text-white","cursor-not")),c.forEach(e=>e.removeAttribute("disabled"));const t=document.querySelector(`label[for='${e}']`);t.classList.add("btn_detail","text-white","cursor-not");const o=document.querySelector(`input#${e}`);o.setAttribute("disabled","disabled"),y="#000","dark-v11"===e&&(y="#fff"),localStorage.setItem("mapbox-last_layer",e)}}function t(e){w.setStyle("mapbox://styles/mapbox/"+e)}function o(){w.getSource("directions")&&(p=w.getSource("directions")._data)}function a(e){w.getCanvas().style.cursor=e}function i(e){v&&v.remove();let t=localStorage.getItem("data-color_rgb");v=new mapboxgl.Marker({color:t||"#3b71ca",draggable:!1}).setLngLat(e).addTo(w)}var n="pk.eyJ1IjoiY2hhdmEtdXRjIiwiYSI6ImNtOTdqdm13cjA4ZGsyaW9rc2g0OGRmdWoifQ.oxLDSCy8_q3xLJNVtDHmDw",r=document.getElementById("map");const s=localStorage.getItem("mapbox-last_layer"),c=document.querySelectorAll("#offcanvasbody input[type='radio']"),l=document.querySelectorAll("#offcanvasbody label"),d=document.querySelector("#form_route"),u=d.querySelector("#origen"),m=d.querySelector("#destino");let p,f=!0,g=!1,y="#000";var v;const h=document.querySelector("#infoLateral"),b=bootstrap.Offcanvas.getInstance(h)||new bootstrap.Offcanvas(h);mapboxgl.accessToken=n;const w=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/streets-v12",center:[-100.93655,25.55701],zoom:16,maxZoom:20,minZoom:15,maxBounds:[[-100.9736,25.5142],[-100.9117,25.5735]]}),k=new mapboxgl.GeolocateControl({positionOPtions:{enableHighAccuracy:!0},trackUserLocation:!0,ShowUserHeading:!0});w.addControl(k),$("#switchTheme").click(function(){$("#switchTheme").is(":checked")?(y="#000",t("streets-v12"),e("streets-v12")):(y="#fff",t("dark-v11"),e("dark-v11"))}),h.addEventListener("hidden.bs.offcanvas",function(){g=!1}),$("#deletePleace").on("hidden.bs.modal",function(e){$("#btnDeletedPleace").hide(),$("[data-namePleace]").text("")}),w.addControl(new mapboxgl.NavigationControl);class C{constructor(){this._container=null}onAdd(e){this._container=document.createElement("div"),this._container.className="mapboxgl-ctrl mapboxgl-ctrl-group";const t=(e,t,o,a)=>{const i=document.createElement("button");return i.className="mapboxgl-ctrl-"+e,i.innerHTML=t,i.title=o,i.type="button",i.onclick=a,i},o=t("gmaps",'<div class="mapboxgl-ctrl-icon"><i class="fa-solid fa-map-location-dot"></i></div>',"Google Maps",()=>{document.querySelectorAll(".offcanvas.show").forEach(e=>{const t=bootstrap.Offcanvas.getInstance(e);t&&t.hide()});var e=new mdb.Modal(document.getElementById("beforeSend"));e.show()}),a=t("styles",'<i class="fa-solid fa-layer-group"></i>',"Cambiar Aspecto",()=>{document.querySelectorAll(".offcanvas.show").forEach(e=>{const t=bootstrap.Offcanvas.getInstance(e);t&&t.hide()});const e=new bootstrap.Offcanvas(document.querySelector("#offcanvasBottom"));e.show()}),i=t("route",'<div class="mapboxgl-ctrl-icon"><i class="fa-solid fa-route"></i></div>',"Como ir a...",()=>$("#controlsRoute").toggleClass("show"));if(this._container.appendChild(o),this._container.appendChild(a),this._container.appendChild(i),r.classList.contains("map_editing")){const e=t("newBuild",'<i class="fa-solid fa-building-flag"></i>',"Crear Nuevo Edificio",()=>{$("#btnDeletedPleace").hide(),$("[data-namePleace]").text(""),$("#offcanvasContent input").removeClass("active is-invalid is-valid").val(""),$(".error.bg-danger").slideUp("fast"),document.getElementById("imagen_actual").src="/static/img/default_image.webp",$("#offcanvasContent #isNewEdif").val("new");const e=$("#uuid").data("new-uid");$("#uuid").removeClass("active").val(e),$("#colorPicker").addClass("active").val("#808080"),$("#fotoEdificio").attr("required",!0),tinymce.get("textTiny").setContent(""),$("#ismarker").val("False"),$("#checkIsmarker").removeAttr("checked"),$("#sizemarkerdiv").slideUp(),$("[data-notmarker]").slideDown(),$("#hidename").slideDown(),$("#btnOpenGalery").slideUp(),g||(h.classList.contains("show")?b.hide():b.show())}),o=t("OSMgo",'<i class="fa-solid fa-book-atlas"></i>',"Editar en OpenStreetMaps",()=>{const e="https://www.openstreetmap.org/edit#map=17/25.55684/-100.93548";window.open(e,"_blank","noopener,noreferrer")}),a=t("importmap",'<div class="mapboxgl-ctrl-icon"><i class="fa-solid fa-cloud-arrow-up"></i></div>',"Importar y Exportar",()=>{var e=new mdb.Modal(document.getElementById("importInMap"));e.show()});this._container.appendChild(o),this._container.appendChild(a),this._container.appendChild(e)}return this._container}}s&&(e(s),t(s));const S=new MapboxDirections({accessToken:mapboxgl.accessToken,unit:"metric",profile:"mapbox/walking",controls:{inputs:!1,instructions:!1,profileSwitcher:!1},alternatives:!0,interactive:!1});w.addControl(new C,"top-right"),w.getCanvas().style.cursor="default",w.on("dragstart",()=>a("move")),w.on("dragend",()=>a("default")),w.on("mousedown",()=>a("pointer")),w.on("mouseup",()=>a("default")),w.on("mouseover",()=>a("default")),r.classList.contains("map_user")&&w.on("click",function(e){const t=e.lngLat;i(t)}),c.forEach(a=>{a.addEventListener("click",function(a){const i=a.target.id;e(i),o(),t(i)})});const x=document.querySelector("#map").getAttribute("data-mapa_markers");fetch(x).then(e=>e.json()).then(e=>{function t(){e.forEach(e=>{const t=e.nombre.replace(" ","");w.getSource(e.uuid)||w.addSource(e.uuid,{type:"geojson",data:{type:"FeatureCollection",features:[{type:"Feature",properties:{uuid:e.uuid,nombre:e.nombre,imagen:e.imagen,ismarker:e.ismarker,icon_size:e.icon_size,sizemarker:e.sizemarker,edges:[[e.edges[0],e.edges[1],e.edges[2],e.edges[3]]]},geometry:{type:"Point",coordinates:e.coords}}]}}),w.hasImage(t)||w.loadImage(e.imagen,(e,o)=>{if(e)throw e;w.addImage(t,o)}),w.getLayer(`points${t}`)||w.addLayer({id:`points${t}`,type:"symbol",source:e.uuid,layout:{"icon-image":t,"icon-size":e.icon_size,"icon-allow-overlap":!0}})})}w.on("load",()=>{t()}),w.on("style.load",()=>{t()}),w.on("click",t=>{if(f&&r.classList.contains("map_editing")){const i=w.queryRenderedFeatures(t.point,{layers:e.map(e=>`points${e.nombre.replace(" ","")}`)});if(i.length){const e=i[0],{nombre:t,imagen:n,uuid:r,ismarker:s,icon_size:c,edges:l}=e.properties,d=e.geometry.coordinates.slice(),u=document.getElementById("offcanvasContent");document.getElementById("imagen_actual").src=n,$("#btnDeletedPleace").show(),$("[data-namePleace]").text(t),u.querySelector("#isNewEdif").value="notnew",s?($("#ismarker").val("True"),$("#checkIsmarker").attr("checked","checked"),$("#sizemarkerdiv").slideDown("fast"),$("[data-notmarker]").slideUp(),$('[for="puertaCordsEdificio"]').text("Ubicacion:")):($("#ismarker").val("False"),$("#checkIsmarker").removeAttr("checked")),$("#hidename").slideUp(),$("[data-uuid]").addClass("active").val(r),$("#nombreEdificio").addClass("active").val(t),$("#sizemarker").addClass("active").val(c),$("#puertaCordsEdificio").addClass("active").val(`${d}`),$("#fotoEdificio").attr("required",!1),$("#esquina1").addClass("active").val(l[0]),$("#esquina2").addClass("active").val(l[1]),$("#esquina3").addClass("active").val(l[2]),$("#esquina4").addClass("active").val(l[3]);var o=document.getElementById("pleaceGalery"),a=bootstrap.Offcanvas.getInstance(o);a&&a.hide(),b.show(),g=!0}}})}).catch(e=>{console.error("Error al obtener Marcadores del mapa:"),console.error(e),alertSToast("top",5e3,"error","Ocurrio un error inesperado. #403")});const L=document.querySelector("#map").getAttribute("data-mapa_edif");if(fetch(L).then(e=>e.json()).then(e=>{function t(){w.getSource("places")||w.addSource("places",{type:"geojson",data:n}),w.getLayer("places-layer")||w.addLayer({id:"places-layer",type:"fill",source:"places",paint:{"fill-color":["get","color"],"fill-opacity":.4}}),w.getLayer("places-label")||(w.addLayer({id:"places-label",type:"symbol",source:"places",layout:{"text-field":["get","label"],"text-size":12,"text-offset":[0,-.6],"text-anchor":"top"},paint:{"text-color":y}}),w.moveLayer("places-label"))}function o(){const e=u.value,t=m.value;if(e&&t&&e!==t){const o=n.features.find(t=>t.properties.nombre===e),i=n.features.find(e=>e.properties.nombre===t);if(o&&i){const e=o.properties.door,t=i.properties.door;S.setOrigin(e),S.setDestination(t),$("#buttons_route").slideDown("slow"),S.on("route",e=>{const t={type:"FeatureCollection",features:e.route.map(e=>({type:"Feature",geometry:e.geometry,properties:{}}))};p=t;const o=e.route[0].distance,a=e.route[0].duration;let i;i=o<1e3?`${Math.round(o)} m`:`${(o/1e3).toFixed(2)} km`;const n=Math.floor(a/60),r=Math.round(a%60);let s;s=0===r?`${n} min`:0===n?`${r} s`:`${n}:${r.toString().padStart(2,"0")} min`,$("#route-info").html(`<div class="row">\n                                    <div class="col-1 mb-2">\n                                        <i class="fa-solid fa-shoe-prints me-1"></i>\n                                    </div>\n                                    <div class="col-10 mb-2">\n                                        Distancia: <strong>${i}</strong>\n                                    </div>\n                                \n                                    <div class="col-1">\n                                        <i class="fa-solid fa-hourglass-half me-1"></i>\n                                    </div>\n                                    <div class="col-10">\n                                        Duración: <strong>${s} aprox.</strong>\n                                    </div>\n                                </div>`),$("#route-info").slideDown()}),window.innerWidth<=800&&setTimeout(()=>{$("#controls_route").removeClass("show")},4e3),w.addControl(S,"top-left"),w.moveLayer("places-label"),a()}}else alertSToast("center",5e3,"warning","Por favor, selecciona tanto origen como destino.")}function a(){if(p&&p.features&&p.features.length>0){w.getSource("directions")||w.addSource("directions",{type:"geojson",data:p});const e=p.features.find(e=>"origin"===e.properties.id),t=p.features.find(e=>"destination"===e.properties.id);w.getLayer("directions-route-line")||w.addLayer({id:"directions-route-line",type:"line",source:"directions",layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#2d5f99","line-width":12},filter:["==","$type","LineString"]}),w.getLayer("directions-route-line-alt")||w.addLayer({id:"directions-route-line-alt",type:"line",source:"directions",layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#4882c5","line-width":6},filter:["==","$type","LineString"]}),w.getLayer("directions-origin-point")||w.addLayer({id:"directions-origin-point",type:"circle",source:"directions",paint:{"circle-color":"#3bb2d0","circle-radius":20},filter:["==",["get","id"],"origin"]}),w.getLayer("directions-destination-point")||w.addLayer({id:"directions-destination-point",type:"circle",source:"directions",paint:{"circle-color":"#8a8bc9","circle-radius":20},filter:["==",["get","id"],"destination"]}),w.getLayer("directions-origin-label")||w.addLayer({id:"directions-origin-label",type:"symbol",source:"directions",layout:{"text-field":e.properties["marker-symbol"],"text-font":["Open Sans Bold","Arial Unicode MS Bold"],"text-size":18},paint:{"text-color":"#fff"},filter:["==",["get","id"],"origin"]}),w.getLayer("directions-destination-label")||w.addLayer({id:"directions-destination-label",type:"symbol",source:"directions",layout:{"text-field":t.properties["marker-symbol"],"text-font":["Open Sans Bold","Arial Unicode MS Bold"],"text-size":18},paint:{"text-color":"#fff"},filter:["==",["get","id"],"destination"]}),w.moveLayer("places-label")}}function i(){const e=new URLSearchParams(window.location.search);return{origin:e.get("origin"),destiny:e.get("destiny")}}const n={type:"FeatureCollection",features:e.map(e=>({type:"Feature",properties:{uuid:e.uuid,color:e.color,label:e.hidename?"":e.nombre,nombre:e.nombre,door:e.coords,ismarker:e.ismarker,imagen_url:e.imagen_url,informacion:e.informacion,galery_count:e.galery_count,galery_items:e.galery_items},geometry:{type:"Polygon",coordinates:[[e.polygons[0],e.polygons[1],e.polygons[2],e.polygons[3],e.polygons[0]]]}}))};console.log(n),w.on("load",function(){t()}),w.on("style.load",function(){t(),a()}),w.on("click","places-layer",e=>{const t=e.features[0],{nombre:o,informacion:a,imagen_url:i,galery_count:n,galery_items:s}=t.properties,{coordinates:c}=t.geometry,l=document.getElementById("offcanvasContent");if(f){if(i&&(document.getElementById("imagen_actual").src=`/media/${i}`),r.classList.contains("map_user"))document.getElementById("lateralTitle").innerText=o,l.innerHTML=`<div class="feature-info"><p>${a}</p></div>`;else if(r.classList.contains("map_editing")){$("#offcanvasContent input").removeClass("active is-invalid is-valid").val(""),$(".error.bg-danger").slideUp("fast");const{color:e,door:i,uuid:r,ismarker:s,label:l}=t.properties;$("#checkIsmarker").is(":checked")&&($("#sizemarkerdiv").slideUp(),$("[data-notmarker]").slideDown()),$("#btnDeletedPleace").show(),$("#btnOpenGalery").slideDown(),$("[data-namePleace]").text(o),$("#galeryCount").text(n),$("#isNewEdif").val("notnew"),$("#sizemarker").val("0.5"),$("#colorPicker").val(e),pickr.setColor(e),s?($("#ismarker").val("True"),$("#checkIsmarker").attr("checked","checked")):($("#ismarker").val("False"),$("#checkIsmarker").removeAttr("checked")),$("#hidename").slideDown(),""!=l?$("#hidename").attr("checked","checked"):$("#hidename").removeAttr("checked"),$("[data-uuid]").addClass("active").val(r),$("#nombreEdificio").addClass("active").val(o),$(".name_pleace").text(o);const d=i.slice(1,-1).split(",");$("#puertaCordsEdificio").addClass("active").val(`${d[0]},${d[1]}`),$("#esquina1").addClass("active").val(c[0][0]),$("#esquina2").addClass("active").val(c[0][1]),$("#esquina3").addClass("active").val(c[0][2]),$("#esquina4").addClass("active").val(c[0][3]),$("#fotoEdificio").attr("required",!1),tinymce.get("textTiny").setContent(a)}b.show(),g=!0}});const s=n.features.map(e=>e.properties.nombre).sort();s.forEach(e=>{const t=new Option(e,e);document.getElementById("origen").add(t),document.getElementById("destino").add(t.cloneNode(!0))}),u.addEventListener("change",function(){const e=this.value;m.querySelectorAll("option").forEach(t=>{t.disabled=t.value===e});const t=new URLSearchParams(window.location.search);t.set("origin",e),history.replaceState({},"",`${location.pathname}?${t}`),m.value&&o()}),m.addEventListener("change",function(){const e=this.value;u.querySelectorAll("option").forEach(t=>{t.disabled=t.value===e});const t=new URLSearchParams(window.location.search);t.set("destiny",e),history.replaceState({},"",`${location.pathname}?${t}`),u.value&&o()});const{origin:c,destiny:l}=i();if(c&&l&&c!==l){const e=n.features.find(e=>e.properties.nombre===c),t=n.features.find(e=>e.properties.nombre===l);if(e&&t){const e=u.querySelector(`option[value="${c}"]`),t=m.querySelector(`option[value="${l}"]`);e&&(e.selected=!0,u.dispatchEvent(new Event("change"))),setTimeout(()=>{t&&(t.selected=!0,m.dispatchEvent(new Event("change"))),o()},3e3)}}$("[data-reset_form]").on("click",function(){$("option").each(e=>{e.disabled=!1});const e=["directions-route-line","directions-route-line-alt","directions-route-line-casing","directions-hover-point-casing","directions-hover-point","directions-waypoint-point-casing","directions-waypoint-point","directions-origin-point","directions-origin-label","directions-destination-point","directions-destination-label"];e.forEach(e=>{w.getLayer(e)&&w.removeLayer(e)}),w.getSource("directions")&&w.removeSource("directions"),$("#buttons_route").slideUp("slow"),$("#route-info").slideUp("slow",()=>{$("#route-info").empty()});const t=new URLSearchParams(window.location.search);t.delete("origin"),t.delete("destiny"),history.replaceState({},"",`${location.pathname}?${t.toString()}`)})}).catch(e=>{console.error("Error al obtener lugares del mapa:"),console.error(e),alertSToast("top",5e3,"error","Ocurrio un error inesperado. #403")}),r.classList.contains("map_editing")){const e=new MapboxDraw({displayControlsDefault:!1});function E(t){t.features.length>0&&t.features.forEach(t=>{e.delete(t.id)})}function _(t){const o=e.getAll();if($("#controlsIndic").removeClass("show"),$("#delPoligonGroup").removeClass("none"),$("#btnPoligon").html('Modificar <i class="fa-solid fa-draw-polygon ms-1"></i>'),o.features.length>0){const e=o.features[0],t=e.geometry.coordinates[0];$("#coords").val(JSON.stringify(t));const a=turf.area(e),i=(Math.round(100*a),turf.length(e,{units:"kilometers"}));Math.round(1e3*i*100),turf.centroid(e)}else $("#controlsIndic").removeClass("show"),$("#controlsIndic .card-body p").html(""),"draw.delete"!==t.type&&alert("Haz clic en el mapa para dibujar un polígono.")}w.addControl(e),w.on("draw.create",_),w.on("draw.delete",_),w.on("draw.update",_),$("#btnPoligon").click(function(){f=!1;const t=e.getAll();E(t),$("#controlsIndic").addClass("show"),$("#delPoligonGroup").addClass("none"),$(this).html('Dibujando... <i class="fa-solid fa-draw-polygon ms-1"></i>'),e.changeMode("draw_polygon")}),$("#delPoligon").click(function(){f=!0,$("#controlsIndic").removeClass("show"),$("#delPoligonGroup").addClass("none");const t=e.getAll();E(t)})}});