window.addEventListener("load",()=>{function e(e){if(e){d.forEach(e=>e.classList.remove("btn_detail","text-white","cursor-not")),c.forEach(e=>e.removeAttribute("disabled"));const o=document.querySelector(`label[for='${e}']`);o.classList.add("btn_detail","text-white","cursor-not");const t=document.querySelector(`input#${e}`);t.setAttribute("disabled","disabled"),h="#000","dark-v11"===e&&(h="#fff"),localStorage.setItem("mapbox-last_layer",e)}}function o(e){C.setStyle("mapbox://styles/mapbox/"+e)}function t(){C.getSource("directions")&&(v=C.getSource("directions")._data)}function a(e){C.getCanvas().style.cursor=e}function n(e){y&&y.remove();let o=localStorage.getItem("data-color_rgb");y=new mapboxgl.Marker({color:o||"#3b71ca",draggable:!1}).setLngLat(e).addTo(C)}function i(){const e=new URLSearchParams(window.location.search);return{origin:e.get("origin"),destiny:e.get("destiny")}}var r="pk.eyJ1IjoiY2hhdmEtdXRjIiwiYSI6ImNtOTdqdm13cjA4ZGsyaW9rc2g0OGRmdWoifQ.oxLDSCy8_q3xLJNVtDHmDw",s=document.getElementById("map");const l=localStorage.getItem("mapbox-last_layer"),c=document.querySelectorAll("#offcanvasbody input[type='radio']"),d=document.querySelectorAll("#offcanvasbody label"),p=document.querySelector("#form_route"),u=p.querySelector("#origen"),m=p.querySelector("#destino");let f=!0,g=!1,h="#000";var y;let v,b;const w=document.querySelector("#infoLateral"),k=bootstrap.Offcanvas.getInstance(w)||new bootstrap.Offcanvas(w);mapboxgl.accessToken=r;const C=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/streets-v12",center:[-100.93655,25.55701],zoom:16,maxZoom:20,minZoom:15,maxBounds:[[-100.9736,25.5142],[-100.9117,25.5735]]});window.mapMapbox=C;const S=new mapboxgl.GeolocateControl({positionOPtions:{enableHighAccuracy:!0},trackUserLocation:!0,ShowUserHeading:!0});C.addControl(S),s.classList.contains("map_editing")&&(b=new MapboxDraw({displayControlsDefault:!1})),$("#switchTheme").click(function(){$("#switchTheme").is(":checked")?(h="#000",o("streets-v12"),e("streets-v12")):(h="#fff",o("dark-v11"),e("dark-v11"))}),w.addEventListener("hidden.bs.offcanvas",function(){g=!1}),$("#deletePleace").on("hidden.bs.modal",function(e){$("#btnDeletedPleace").hide(),$("[data-namePleace]").text("")}),C.addControl(new mapboxgl.NavigationControl);class _{constructor(){this._container=null}onAdd(e){this._container=document.createElement("div"),this._container.className="mapboxgl-ctrl mapboxgl-ctrl-group";const o=(e,o,t,a)=>{const n=document.createElement("button");return n.className="mapboxgl-ctrl-"+e,n.innerHTML=o,n.title=t,n.type="button",n.onclick=a,n},t=o("gmaps",'<div class="mapboxgl-ctrl-icon"><i class="fa-solid fa-map-location-dot"></i></div>',"Google Maps",()=>{document.querySelectorAll(".offcanvas.show").forEach(e=>{const o=bootstrap.Offcanvas.getInstance(e);o&&o.hide()});var e=new mdb.Modal(document.getElementById("beforeSend"));e.show()}),a=o("styles",'<i class="fa-solid fa-layer-group"></i>',"Cambiar Aspecto",()=>{document.querySelectorAll(".offcanvas.show").forEach(e=>{const o=bootstrap.Offcanvas.getInstance(e);o&&o.hide()});const e=new bootstrap.Offcanvas(document.querySelector("#offcanvasBottom"));e.show()}),n=o("route",'<div class="mapboxgl-ctrl-icon"><i class="fa-solid fa-route"></i></div>',"Como ir a...",()=>$("#controlsRoute").toggleClass("show"));if(this._container.appendChild(t),this._container.appendChild(a),this._container.appendChild(n),s.classList.contains("map_editing")){const e=o("newBuild",'<i class="fa-solid fa-building-flag"></i>',"Crear Nuevo Edificio",()=>{$("#btnDeletedPleace").hide(),$("[data-namePleace]").text(""),$("#offcanvasContent input").removeClass("active is-invalid is-valid"),$(".error.bg-danger").slideUp("fast"),document.getElementById("imagen_actual").src="/static/img/default_image.webp",$("#offcanvasContent #isNewEdif").val("new");const e=$("#uuid").data("new-uid");$("#uuid").removeClass("active").val(e),$("#colorPicker").val("#808080"),$("#fotoEdificio").attr("required",!0),tinymce.get("textTiny").setContent(""),$("#ismarker").val("False"),$("#checkIsmarker").removeAttr("checked"),$("[data-notmarker]").slideDown(),$("#hidename").slideDown(),$("#otherAction option").each(function(){$(this).prop("disabled",!1)}),g||(w.classList.contains("show")?k.hide():k.show())}),t=o("OSMgo",'<i class="fa-solid fa-book-atlas"></i>',"Editar en OpenStreetMaps",()=>{const e="https://www.openstreetmap.org/edit#map=17/25.55684/-100.93548";window.open(e,"_blank","noopener,noreferrer")}),a=o("importmap",'<div class="mapboxgl-ctrl-icon"><i class="fa-solid fa-cloud-arrow-up"></i></div>',"Importar y Exportar",()=>{var e=new mdb.Modal(document.getElementById("importInMap"));e.show()});this._container.appendChild(t),this._container.appendChild(a),this._container.appendChild(e)}return this._container}}l&&(e(l),o(l));const L=new MapboxDirections({accessToken:mapboxgl.accessToken,unit:"metric",profile:"mapbox/walking",controls:{inputs:!1,instructions:!1,profileSwitcher:!1},alternatives:!0,interactive:!1});C.addControl(new _,"top-right"),C.getCanvas().style.cursor="default",C.on("dragstart",()=>a("move")),C.on("dragend",()=>a("default")),C.on("mousedown",()=>a("pointer")),C.on("mouseup",()=>a("default")),C.on("mouseover",()=>a("default")),s.classList.contains("map_user")&&C.on("click",function(e){const o=e.lngLat;n(o)}),c.forEach(a=>{a.addEventListener("click",function(a){const n=a.target.id;e(n),t(),o(n)})});const x=document.querySelector("#map").getAttribute("data-mapa_markers");fetch(x).then(e=>e.json()).then(e=>{function o(){e.forEach(e=>{const o=e.nombre.replace(" ","");C.getSource(e.uuid)||C.addSource(e.uuid,{type:"geojson",data:{type:"FeatureCollection",features:[{type:"Feature",properties:{uuid:e.uuid,nombre:e.nombre,imagen:e.imagen,ismarker:e.ismarker,icon_size:e.icon_size,sizemarker:e.sizemarker},geometry:{type:"Point",coordinates:e.coords}}]}}),C.hasImage(o)||C.loadImage(e.imagen,(t,a)=>{t?console.error("Error al cargar imagen:",e.imagen,t):(C.hasImage(o)||C.addImage(o,a),C.getLayer(`points${o}`)||C.addLayer({id:`points${o}`,type:"symbol",source:e.uuid,layout:{"icon-image":o,"icon-size":e.icon_size,"icon-allow-overlap":!0}}))})})}C.loaded()&&o(),C.on("load",()=>{o()}),C.on("style.load",()=>{o()}),C.on("click",o=>{if(f){const n=C.queryRenderedFeatures(o.point,{layers:e.map(e=>`points${e.nombre.replace(" ","")}`)});if(s.classList.contains("map_editing")&&n.length){const e=n[0],{nombre:o,imagen:i,uuid:r,ismarker:s,icon_size:l}=e.properties,c=e.geometry.coordinates.slice(),d=document.getElementById("offcanvasContent");document.getElementById("imagen_actual").src=i,$("#btnDeletedPleace").show(),$("[data-namePleace]").text(o),d.querySelector("#isNewEdif").value="notnew",s?($("#ismarker").val("True"),$("#checkIsmarker").attr("checked","checked"),$("#sizemarkerdiv").slideDown("fast"),$("[data-notmarker]").slideUp()):($("#ismarker").val("False"),$("#checkIsmarker").removeAttr("checked")),$("#hidename").slideUp(),$("[data-uuid]").addClass("active").val(r),$("#nombreEdificio").addClass("active").val(o),$("#sizemarker").addClass("active").val(l),$("#coords").addClass("active").val(c),$("#fotoEdificio").attr("required",!1);var t=document.getElementById("pleaceGalery"),a=bootstrap.Offcanvas.getInstance(t);a&&a.hide(),$("#otherAction option").each(function(){$(this).prop("disabled",!1)}),k.show(),g=!0}}})}).catch(e=>{console.error("Error al obtener Marcadores del mapa:"),console.error(e),alertSToast("top",5e3,"error","Ocurrio un error inesperado. #403")});const E=document.querySelector("#map").getAttribute("data-mapa_edif");if(fetch(E).then(e=>e.json()).then(e=>{function o(){C.getSource("places")||C.addSource("places",{type:"geojson",data:l}),C.getLayer("places-layer")||C.addLayer({id:"places-layer",type:"fill",source:"places",clickable:!0,paint:{"fill-color":["get","color"],"fill-opacity":["get","opacity"]}}),C.getLayer("places-label")||(C.addLayer({id:"places-label",type:"symbol",source:"places",layout:{"text-field":["get","label"],"text-size":12,"text-offset":[0,-.6],"text-anchor":"top"},paint:{"text-color":h}}),C.moveLayer("places-label"))}function t(e){const o=turf.centroid(e);return o.geometry.coordinates}function a(e){let o=e.properties.door;if(o){if(console.log("Origin Door: ",o),console.log("Origin Door Type: ",typeof o),"string"==typeof o)try{o=JSON.parse(o)}catch(e){console.error("Error al hacer JSON.parse en 'door':",e),o=null}if(console.log("Door (raw):",o),console.log("Type of door (raw):",typeof o),Array.isArray(o)&&2===o.length)return alertSToast("top",5e3,"warning",`La puerta de ${e.properties.nombre} es: ${o}`),o}return t(e)}function n(){const e=u.value,o=m.value;if(e&&o&&e!==o){const t=l.features.find(o=>o.properties.nombre===e),n=l.features.find(e=>e.properties.nombre===o);if(t&&n){const e=a(t),o=a(n);L.setOrigin(e),L.setDestination(o),$("#buttons_route").slideDown("slow"),L.on("route",e=>{const o={type:"FeatureCollection",features:e.route.map(e=>({type:"Feature",geometry:e.geometry,properties:{}}))};v=o;const t=e.route[0].distance,a=e.route[0].duration;let n;n=t<1e3?`${Math.round(t)} m`:`${(t/1e3).toFixed(2)} km`;const i=Math.floor(a/60),r=Math.round(a%60);let s;s=0===r?`${i} min`:0===i?`${r} s`:`${i}:${r.toString().padStart(2,"0")} min`,$("#route-info").html(`<div class="row">\n                                    <div class="col-1 mb-2">\n                                        <i class="fa-solid fa-shoe-prints me-1"></i>\n                                    </div>\n                                    <div class="col-10 mb-2">\n                                        Distancia: <strong>${n}</strong>\n                                    </div>\n                                \n                                    <div class="col-1">\n                                        <i class="fa-solid fa-hourglass-half me-1"></i>\n                                    </div>\n                                    <div class="col-10">\n                                        Duración: <strong>${s} aprox.</strong>\n                                    </div>\n                                </div>`),$("#route-info").slideDown()}),window.innerWidth<=800&&setTimeout(()=>{$("#controls_route").removeClass("show")},4e3),C.addControl(L,"top-left"),C.moveLayer("places-label"),r()}}else alertSToast("center",5e3,"warning","Por favor, selecciona tanto origen como destino.")}function r(){if(v&&v.features&&v.features.length>0){C.getSource("directions")||C.addSource("directions",{type:"geojson",data:v});const e=v.features.find(e=>"origin"===e.properties.id),o=v.features.find(e=>"destination"===e.properties.id);C.getLayer("directions-route-line")||C.addLayer({id:"directions-route-line",type:"line",source:"directions",layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#2d5f99","line-width":12},filter:["==","$type","LineString"]}),C.getLayer("directions-route-line-alt")||C.addLayer({id:"directions-route-line-alt",type:"line",source:"directions",layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#4882c5","line-width":6},filter:["==","$type","LineString"]}),C.getLayer("directions-origin-point")||C.addLayer({id:"directions-origin-point",type:"circle",source:"directions",paint:{"circle-color":"#3bb2d0","circle-radius":20},filter:["==",["get","id"],"origin"]}),C.getLayer("directions-destination-point")||C.addLayer({id:"directions-destination-point",type:"circle",source:"directions",paint:{"circle-color":"#8a8bc9","circle-radius":20},filter:["==",["get","id"],"destination"]}),C.getLayer("directions-origin-label")||C.addLayer({id:"directions-origin-label",type:"symbol",source:"directions",layout:{"text-field":e.properties["marker-symbol"],"text-font":["Open Sans Bold","Arial Unicode MS Bold"],"text-size":18},paint:{"text-color":"#fff"},filter:["==",["get","id"],"origin"]}),C.getLayer("directions-destination-label")||C.addLayer({id:"directions-destination-label",type:"symbol",source:"directions",layout:{"text-field":o.properties["marker-symbol"],"text-font":["Open Sans Bold","Arial Unicode MS Bold"],"text-size":18},paint:{"text-color":"#fff"},filter:["==",["get","id"],"destination"]}),C.moveLayer("places-label")}}const l={type:"FeatureCollection",features:e.map(e=>({type:"Feature",properties:{uuid:e.uuid,color:e.color.split("-")[0],opacity:parseFloat(e.color.split("-")[1])||.4,label:e.hidename?"":e.nombre,nombre:e.nombre,ismarker:e.ismarker,imagen_url:e.imagen_url,informacion:e.informacion,galery_count:e.galery_count,galery_items:e.galery_items,door:e.door},geometry:{type:"Polygon",coordinates:e.coords}}))};C.on("load",function(){o()}),C.on("style.load",function(){o(),r()}),C.on("click","places-layer",e=>{const o=e.features[0],{nombre:t,informacion:a,imagen_url:n,galery_count:i,galery_items:r}=o.properties,{coordinates:l}=o.geometry,c=$("#offcanvasContent"),d=$("#imagen_actual"),p=d.siblings("div");if(f){if(n?(d.attr("src",`/media/${n}`).removeClass("transparent"),p.addClass("mask_white")):(d.addClass("transparent"),p.removeClass("mask_white")),s.classList.contains("map_user"))$("#lateralTitle").text(t),c.html(`<div class="feature-info">${a}</div>`);else if(s.classList.contains("map_editing")){n||(d.attr("src","/static/img/default_image.webp").removeClass("transparent"),p.addClass("mask_white")),$("#offcanvasContent input").removeClass("active is-invalid is-valid"),$(".error.bg-danger").slideUp("fast");const{color:e,uuid:i,ismarker:r,label:s}=o.properties;$("#checkIsmarker").is(":checked")&&($("#sizemarkerdiv").slideUp(),$("[data-notmarker]").slideDown()),$("#btnDeletedPleace").show(),$("[data-namePleace]").text(t),$("#isNewEdif").val("notnew"),$("#sizemarker").val("0.5"),$("#colorPicker").val(e),pickr.setColor(e.split("-")[0]),r?($("#ismarker").val("True"),$("#checkIsmarker").attr("checked","checked")):($("#ismarker").val("False"),$("#checkIsmarker").removeAttr("checked")),$("#hidename").slideDown(),""!=s?$("#hidename").attr("checked","checked"):$("#hidename").removeAttr("checked"),$("[data-uuid]").addClass("active").val(i),$("#nombreEdificio").addClass("active").val(t),$(".name_pleace").text(t);const c=l[0];$("#coords").val(JSON.stringify(c)),$("#fotoEdificio").attr("required",!1),tinymce.get("textTiny").setContent(a),$("#otherAction option").each(function(){$(this).prop("disabled",!1),$(this).val()===t?$(this).prop("disabled",!0):$(this).prop("disabled",!1)});const u=b.getAll();I(u);const m={id:i,type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:l}},[f]=b.add(m);b.changeMode("direct_select",{featureId:f})}k.show(),g=!0}});const c=l.features.map(e=>e.properties.nombre).sort();c.forEach(e=>{const o=new Option(e,e);document.getElementById("origen").add(o),document.getElementById("destino").add(o.cloneNode(!0)),s.classList.contains("map_editing")&&document.getElementById("otherAction").add(o.cloneNode(!0))}),u.addEventListener("change",function(){const e=this.value;m.querySelectorAll("option").forEach(o=>{o.disabled=o.value===e});const o=new URLSearchParams(window.location.search);o.set("origin",e),history.replaceState({},"",`${location.pathname}?${o}`),m.value&&n()}),m.addEventListener("change",function(){const e=this.value;u.querySelectorAll("option").forEach(o=>{o.disabled=o.value===e});const o=new URLSearchParams(window.location.search);o.set("destiny",e),history.replaceState({},"",`${location.pathname}?${o}`),u.value&&n()});const{origin:d,destiny:p}=i();if(d&&p&&d!==p){const e=l.features.find(e=>e.properties.nombre===d),o=l.features.find(e=>e.properties.nombre===p);if(e&&o){const e=u.querySelector(`option[value="${d}"]`),o=m.querySelector(`option[value="${p}"]`);e&&(e.selected=!0,u.dispatchEvent(new Event("change"))),setTimeout(()=>{o&&(o.selected=!0,m.dispatchEvent(new Event("change"))),n()},3e3)}}}).catch(e=>{console.error("Error al obtener lugares del mapa:"),console.error(e),alertSToast("top",5e3,"error","Ocurrio un error inesperado. #403")}),$("[data-reset_form]").on("click",function(){$("option").each(e=>{e.disabled=!1});const e=["directions-route-line","directions-route-line-alt","directions-route-line-casing","directions-hover-point-casing","directions-hover-point","directions-waypoint-point-casing","directions-waypoint-point","directions-origin-point","directions-origin-label","directions-destination-point","directions-destination-label"];e.forEach(e=>{C.getLayer(e)&&C.removeLayer(e)}),C.getSource("directions")&&C.removeSource("directions"),$("#buttons_route").slideUp("slow"),$("#route-info").slideUp("slow",()=>{$("#route-info").empty()});const o=new URLSearchParams(window.location.search);o.delete("origin"),o.delete("destiny"),history.replaceState({},"",`${location.pathname}?${o.toString()}`)}),s.classList.contains("map_editing")){function I(e){e.features.length>0&&e.features.forEach(e=>{b.delete(e.id)})}function D(e){const o=b.getAll();if($("#controlsIndic").removeClass("show"),$("#delPoligonGroup").removeClass("none"),$("#btnPoligon").html('Modificar <i class="fa-solid fa-draw-polygon ms-1"></i>'),o.features.length>0){const e=o.features[0],t=e.geometry.coordinates[0];$("#coords").val(JSON.stringify(t)),f=!0}else $("#controlsIndic").removeClass("show"),"draw.delete"!==e.type&&alertSToast("center",8e3,"error","Haz clic en el mapa para dibujar un polígono.")}C.addControl(b),C.on("draw.create",D),C.on("draw.delete",D),C.on("draw.update",D),$("#btnPoligon").click(function(){f=!1;const e=b.getAll();I(e),$("#controlsIndic").addClass("show"),$("#delPoligonGroup").addClass("none"),$(this).html('Dibujando... <i class="fa-solid fa-draw-polygon ms-1"></i>'),b.changeMode("draw_polygon")}),$("#delPoligon").click(function(){f=!0,$("#controlsIndic").removeClass("show"),$("#delPoligonGroup").addClass("none"),$("#coords").val(""),$("#btnPoligon").html('Edificio <i class="fa-solid fa-draw-polygon ms-1"></i>');const e=b.getAll();I(e)});let e=null,o=!1;$("#delDoor").on("click",function(){$("#doorcoords").val(""),$("#delDoorGroup").addClass("none"),$("#setDoor").removeClass("bg_purple-anim").addClass("bg_purple").html('Establecer punto de entrada <i class="fas fa-door-open ms-1"></i>'),e&&(e.remove(),e=null)}),$("#setDoor").on("click",function(){o?(o=!1,f=!0,e&&(e.remove(),e=null),$("#doorcoords").val(""),$("#delDoorGroup").addClass("none"),$(this).removeClass("bg_purple-anim").addClass("bg_purple").html('Establecer punto de entrada <i class="fas fa-door-open ms-1"></i>')):(o=!0,f=!1,$(this).removeClass("bg_purple").addClass("bg_purple-anim").text("Coloca el punto..."),$("#delDoorGroup").addClass("none"),e&&(e.remove(),e=null),C.once("click",function(t){const a=t.lngLat;e=new mapboxgl.Marker({color:"#ae37cc"}).setLngLat([a.lng,a.lat]).addTo(C),$("#doorcoords").val(JSON.stringify([a.lng,a.lat])),$("#setDoor").removeClass("bg_purple-anim").addClass("bg_purple").html('Cambiar punto de entrada <i class="fas fa-door-open ms-1"></i><i class="fas fa-trash-can"></i>'),$("#delDoorGroup").removeClass("none"),o=!1,f=!0}))})}});